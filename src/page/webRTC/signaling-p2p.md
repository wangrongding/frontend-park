# ç–«æƒ…å½“ä¸‹ï¼Œè¿œç¨‹å…´èµ·ï¼Œå‰ç«¯éŸ³è§†é¢‘é€šè¯ï¼Ÿå­¦ï¼ğŸ”¥

## å‰è¨€

- [WebRTC ä»å®æˆ˜åˆ°æœªæ¥ï¼è¿æ¥é£å£ï¼Œå‰ç«¯å¿…å­¦çš„æŠ€æœ¯ ğŸ”¥](https://juejin.cn/post/7151932832041058340)
- [WebRTC ä»å®æˆ˜åˆ°æœªæ¥ï¼å‰ç«¯å¦‚ä½•å®ç°ä¸€ä¸ªæœ€ç®€å•çš„éŸ³è§†é¢‘é€šè¯ï¼ŸğŸ”¥](https://juejin.cn/post/7165539003465531399)

çœ‹åˆ°å‰ä¸¤ç¯‡æ–‡ç« éƒ½éå¸¸å—æ¬¢è¿ï¼Œéå¸¸çš„å¼€å¿ƒï¼ğŸ¤– ç»§ç»­åŠ æ²¹ï¼å†²ï¼  
æˆ‘ä»¬ä¹Ÿåœ¨å‰ä¸¤ç¯‡æ–‡ç« ä¸­å¤§æ¦‚è®²è§£äº† éŸ³è§†é¢‘åª’ä½“æµçš„è·å–ï¼Œå¤„ç†ï¼Œä»¥åŠåœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ä¸ºäº†æ›´ç›´è§‚çš„æ¼”ç¤º WebRTC å»ºç«‹ç‚¹å¯¹ç‚¹é€šä¿¡çš„è¿‡ç¨‹ï¼Œé€šè¿‡æ‰‹åŠ¨äº¤æ¢ sdp æ¥å»º p2p è¿æ¥ï¼Œå®ç°äº†ä¸€ä¸ªæœ€ç®€å•çš„éŸ³è§†é¢‘é€šè¯ï¼Œä½†åœ¨å®é™…çš„åº”ç”¨åœºæ™¯ä¸­ï¼Œæˆ‘ä»¬å‡ ä¹ä¸å¯èƒ½ä¼šé€šè¿‡æ‰‹åŠ¨æ¥äº¤æ¢ sdp ï¼Œå› ä¸ºè¿™æ ·ä¼šå¢åŠ å¾ˆå¤šçš„å·¥ä½œé‡ï¼Œä¹Ÿä¸æ–¹ä¾¿ï¼Œæ‰€ä»¥æˆ‘ä»¬å€ŸåŠ©ä¸€ä¸ªä¿¡ä»¤æœåŠ¡å™¨æ¥å¸®åŠ©æˆ‘ä»¬å®ç°è‡ªåŠ¨å»ºç«‹è¿æ¥çš„è¿™ä¸ªè¿‡ç¨‹ã€‚

![](https://assets.fedtop.com/picbed/202211132222279.png)

## ä»è¿™ç¯‡æ–‡ç« ä¸­ä½ å°†å­¦åˆ°

- å­¦ä¼šå¦‚ä½•åˆ¶ä½œ https çš„è‡ªç­¾åè¯ä¹¦
- å­¦ä¼šå¦‚ä½•ä½¿ç”¨ nginx åå‘ä»£ç† https
- å­¦ä¼šä½¿ç”¨ socket.io æ¥å®ç°å®¢æˆ·ç«¯ä¸ä¿¡ä»¤æœåŠ¡å™¨çš„é€šä¿¡
- äº†è§£å¹¶å®ç°ä¸€ä¸ª WebRTC + ä¿¡ä»¤æœåŠ¡å™¨è‡ªåŠ¨å»ºç«‹è¿æ¥çš„éŸ³è§†é¢‘å®æ—¶é€šè¯

## ä½“éªŒåœ°å€

[ğŸ‘‰ğŸ» 1.æœ¬æ–‡ç¤ºä¾‹åœ¨çº¿ä½“éªŒåœ°å€](https://frontend-park.vercel.app/audio-and-video/webRTC/signaling-p2p)  
[ğŸ‘‰ğŸ» 2.æœ¬æ–‡å®¢æˆ·ç«¯æºä»£ç åœ°å€](https://github.com/wangrongding/frontend-park)  
[ğŸ‘‰ğŸ» 3.æœ¬æ–‡æœåŠ¡ç«¯æºä»£ç åœ°å€](https://github.com/wangrongding/node-park/blob/main/src/signaling/signaling-http-server.js)

ä½ å¯ä»¥å¼€ä¸¤ä¸ªæµè§ˆå™¨ tab æˆ–è€…ç”¨ä¸åŒçš„è®¾å¤‡ï¼Œæ ¹æ®è¯´æ˜å³å¯ä½“éªŒã€‚

![](https://assets.fedtop.com/picbed/202211132359202.png)

## äº†è§£ä¿¡ä»¤å‰ï¼Œéœ€è¦äº†è§£çš„å‡ ä¸ªæ¦‚å¿µ

ç»“åˆä¸Šä¸€ç¯‡è®²åˆ°çš„ `SDP` , `NAT` , `ICE`ï¼Œæˆ‘ä»¬è¿˜éœ€è¦äº†è§£ï¼š`STUN`ï¼Œ`TURN`æœåŠ¡ï¼Œä»¥åŠ`ICEå€™é€‰è€…çš„ç§ç±»`ã€‚

### å€™é€‰è€…çš„ç§ç±»

WebRTC ä¼—å¤šçš„é“¾æ¥å€™é€‰è€…ä¸­ï¼Œå¯ä»¥åˆ†ä¸ºä¸‰ç±»ï¼š

- `host`ï¼šæœ¬æœºå€™é€‰è€…ï¼ˆè®¾å¤‡çš„ ipv4 æˆ– ipv6 åœ°å€ï¼Œå³å†…ç½‘åœ°å€ï¼Œä¸€èˆ¬ä¼šæœ‰ä¸¤ä¸ªï¼Œåˆ†åˆ«å¯¹åº” udp å’Œ tcpï¼Œip ç›¸åŒï¼Œç«¯å£ä¸åŒï¼‰ï¼ŒICE å°è¯•ä¸å¯¹æ–¹å»ºç«‹ P2P è¿æ¥æ—¶çš„é¦–é€‰ï¼Œä¸€èˆ¬è¿™ä¸ªåœ°å€ä¸ºå†…ç½‘åœ°å€ï¼Œå¦‚æœåŒæ–¹ä½äºåŒä¸€ä¸ªå†…ç½‘ï¼Œé‚£ä¹ˆç›´æ¥å»ºç«‹æˆåŠŸã€‚
- `srflx`ï¼šP2P é“¾æ¥å€™é€‰è€…ï¼ˆSTUN æœåŠ¡è¿”å›çš„ä½ è¿™ä¸ªä¸»æœºçš„å¤–ç½‘åœ°å€ï¼‰ï¼Œåœ¨ç¬¬ä¸€æ¬¡å°è¯•è¿æ¥å¤±è´¥æ—¶ï¼Œè¯´æ˜åŒæ–¹ä¸åœ¨åŒä¸€ä¸ªå†…ç½‘ï¼ŒICE å°†ä½¿ç”¨ STUN æœåŠ¡è·å–ä¸»æœºçš„å…¬ç½‘åœ°å€ä»¥åŠæ˜ å°„ç«¯å£ï¼Œç„¶åå¼€å§‹å°è¯•é€šè¿‡ç”¨è¿™ä¸ªå…¬ç½‘ IP å’Œå¯¹æ–¹å»ºç«‹è¿æ¥ã€‚
- `relay`ï¼šä¸­ç»§æœåŠ¡å™¨å€™é€‰è€…ï¼Œå¦‚æœç¬¬äºŒæ¬¡ä»ç„¶å¤±è´¥äº†ï¼ˆå½“ `STUN` ä¸é€‚ç”¨æ—¶(æŸäº› NAT ä¼šä¸ºæ¯ä¸ªè¿æ¥åˆ†é…ä¸åŒçš„ç«¯å£ï¼Œå¯¼è‡´è·å–çš„ç«¯å£å’Œè§†é¢‘è¿æ¥ç«¯å£å¹¶ä¸ä¸€è‡´ï¼‰ï¼Œé‚£ä¹ˆæ„å‘³ç€åŒæ–¹æ— æ³•ç›´æ¥å»ºç«‹ P2P è¿æ¥ï¼Œè¿™æ—¶å€™å°±åªèƒ½é€šè¿‡ä¸€ä¸ªä¸­ç»§æœåŠ¡å™¨ï¼Œå³ `TURN` æœåŠ¡å™¨æ¥å’ŒåŒæ–¹å»ºç«‹è¿æ¥ï¼Œç„¶åä¸­è½¬ä»–ä»¬ä¹‹é—´ä¼ è¾“çš„å†…å®¹ï¼Œè¿™ç§å¯¹æœåŠ¡å™¨å¼€é”€æœ€å¤§ï¼Œè€Œä¸”ä¹Ÿä¼šå¢åŠ æ—¶å»¶ï¼Œæ‰€ä»¥åªæœ‰åœ¨æ²¡å¾—é€‰æ‹©çš„æƒ…å†µä¸‹é‡‡ç”¨ã€‚

æ‰€ä»¥å¯ä»¥æ€»ç»“ä¸ºä¸‰ç±»å€™é€‰è€…ä¸­ï¼Œ`host` å€™é€‰è€…çš„ä¼˜å…ˆçº§æ˜¯æœ€é«˜çš„ï¼Œå½“ `host` ç±»å‹çš„å€™é€‰è€…æ— æ³•å»ºç«‹é“¾æ¥çš„æ—¶å€™ï¼ŒWebRTC ä¼šä» `srflx` å€™é€‰è€…ä¸­è¿›è¡Œè¿é€šæ€§æµ‹è¯•ï¼Œä¹Ÿå°±æ˜¯å°è¯•é€šè¿‡ `P2P` çš„æ–¹å¼è¿æ¥åŒæ–¹ï¼Œå¦‚æœå¤±è´¥æ‰ä¼šå°è¯•ä½¿ç”¨ `relay` çš„æ–¹å¼è¿›è¡Œé“¾æ¥ã€‚

### STUN (Session Traversal Utilities for NAT)

æˆ‘ä»¬éœ€è¦çŸ¥é“çš„æ˜¯ï¼šä¸»æœºè¦æƒ³è®¿é—®å…¬ç½‘èµ„æºï¼Œå¿…é¡»æœ‰è‡ªå·±çš„å…¬ç½‘åœ°å€ï¼Œåªæœ‰è¿™æ ·ï¼Œæˆ‘ä»¬æ‰èƒ½åœ¨è®¿é—®èµ„æºä¸»æœºçš„æ—¶å€™ï¼Œè®©å®ƒé€šè¿‡æˆ‘ä»¬ä¸»æœºçš„å…¬ç½‘åœ°å€æ‰¾åˆ°æˆ‘ä»¬çš„ä¸»æœºï¼Œå¹¶æŠŠä½ æƒ³è¦è®¿é—®çš„èµ„æºå‘é€ç»™ä½ ã€‚

> ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåœ¨ä¸€ä¸ªç½‘æ®µå†…çš„ä¸»æœºåªæœ‰å†…ç½‘ IP å’Œç«¯å£å·ï¼Œé‚£å†…ç½‘çš„ä¸»æœºæ˜¯å¦‚ä½•è®¿é—®å…¬ç½‘èµ„æºçš„å‘¢ï¼Ÿå®é™…ä¸Šï¼Œå†…ç½‘çš„ç½‘å…³éƒ½æœ‰ NAT çš„åŠŸèƒ½ï¼ŒNAT çš„åŠŸèƒ½æ˜¯å°†å†…ç½‘ IP æ˜ å°„è½¬æ¢æˆå…¬ç½‘åœ°å€ã€‚å½“æˆ‘ä»¬çš„å†…ç½‘ä¸»æœºæƒ³è¦è®¿é—®å…¬ç½‘èµ„æºçš„æ—¶å€™ï¼Œå†…ç½‘ç½‘å…³ä¼šå°†è¯·æ±‚çš„å†…ç½‘åœ°å€æ˜ å°„æˆå…¬ç½‘åœ°å€ï¼Œç„¶åå°†è¯·æ±‚å‘é€åˆ°è¦è®¿é—®çš„å…¬ç½‘æœåŠ¡å™¨ä¸Šï¼ŒæœåŠ¡å™¨å¤„ç†å¥½è¯·æ±‚ä¹‹åï¼Œå°†å“åº”æ•°æ®ä¼ é€’ç»™è¯·æ±‚ä¸­æºå¸¦çš„å…¬ç½‘åœ°å€ä¸Šï¼Œè¯¥å…¬ç½‘æ¥æ”¶åˆ°å“åº”æ•°æ®ä¹‹åï¼Œå®ƒçš„ç½‘å…³å°±ä¼šé€šè¿‡ä¹‹å‰çš„åœ°å€æ˜ å°„æœ€ç»ˆä¸­è½¬ç»™å†…ç½‘çš„ä¸»æœºã€‚é€šè¿‡è¿™ç§æ–¹å¼å®ç°å†…ç½‘ä¸»æœºè®¿é—®å…¬ç½‘èµ„æºçš„éœ€æ±‚ã€‚  
> åŸºäºä»¥ä¸Šçš„è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“å†…ç½‘ä¸»æœºè™½ç„¶ä¸çŸ¥é“è‡ªå·±åœ¨å…¬ç½‘çš„åœ°å€ï¼Œä½†æ˜¯å†…ç½‘ä¸»æœºè®¿é—®çš„æœåŠ¡å™¨æ˜¯çŸ¥é“å†…ç½‘ä¸»æœºå¯¹åº”çš„å…¬ç½‘ IP çš„ï¼Œäºæ˜¯æˆ‘ä»¬åœ¨å…¬ç½‘ä¸­æ¶è®¾ä¸€å°æœåŠ¡å™¨ï¼Œé€šè¿‡è¿™å°æœåŠ¡å™¨å¯ä»¥è¯¢é—®åˆ°è‡ªå·±çš„å…¬ç½‘åœ°å€ã€‚å®é™…ä¸Šè¿™ä¸€è¯¢é—®æµç¨‹å·²ç»è¢«å®šä¹‰æˆäº†ä¸€å¥—è§„èŒƒï¼Œå°±æ˜¯ STUN åè®®ã€‚  
> NAT éå†æ“ä½œç”± Session Traversal Utilities for NAT (STUN) æœåŠ¡å™¨æ‰§è¡Œã€‚ STUN æ–¹æ³•æ˜¯ä¸€ç§ç”¨äºç»ˆç«¯æ£€æŸ¥å…¶â€œå…¬å…± IP åœ°å€å’Œç«¯å£â€çš„è¿‡ç¨‹çš„åè®®ã€‚å½“å®¢æˆ·ç«¯å‘ STUN æœåŠ¡å™¨å‘é€è¯·æ±‚æ—¶ï¼Œå®ƒä¼šå‘é€é€šä¿¡æ‰€éœ€çš„ä¿¡æ¯ä»¥åŠå®¢æˆ·ç«¯ç”¨æ¥ä¸å…¶ä»–è®¾å¤‡é€šä¿¡çš„å…¬å…± IP åœ°å€ã€‚ä½†æ˜¯ï¼Œå³ä½¿åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¦‚æœæ— æ³•è¿›è¡Œé€šä¿¡ï¼Œä¹Ÿä¼šå°†å…¶ä¼ è¾“åˆ° TURN æœåŠ¡å™¨ã€‚

ç®€å•æ¦‚æ‹¬å°±æ˜¯ï¼Œæˆ‘ä»¬è¦çŸ¥é“è‡ªå·±çš„`å¤–ç½‘ IP åœ°å€`ï¼Œä¾é çš„å°±æ˜¯ `STUN` æœåŠ¡ã€‚å®¢æˆ·ç«¯é€šè¿‡ç»™å…¬ç½‘çš„ STUN æœåŠ¡å™¨å‘é€è¯·æ±‚è·å¾—è‡ªå·±çš„å…¬ç½‘åœ°å€ä¿¡æ¯ï¼Œä»¥åŠæ˜¯å¦èƒ½å¤Ÿè¢«ï¼ˆç©¿è¿‡è·¯ç”±å™¨ï¼‰è®¿é—®ã€‚

[åè®®åœ°å€](https://www.rfc-editor.org/rfc/rfc5389)

![](https://assets.fedtop.com/picbed/202211141044113.png)

### TURN (Session Traversal Utilities for NAT)

WebRTC é€šä¿¡åŒæ–¹é€šè¿‡ P2P çš„æ–¹å¼æ— æ³•å»ºç«‹é“¾æ¥çš„æƒ…å†µä¸‹ï¼Œä¼šä½¿ç”¨ relay æœåŠ¡è¿›è¡Œä¸­è½¬æœåŠ¡ã€‚ relay æ˜¯æ‰€æœ‰å€™é€‰è€…ä¸­ä¼˜å…ˆçº§æœ€ä½çš„é“¾æ¥æ–¹å¼ï¼Œä½†æ˜¯ relay ä¹Ÿæ˜¯è¿é€šç‡æœ€é«˜çš„æ–¹å¼ã€‚WebRTC é€šä¿¡åŒæ–¹é€šè¿‡å‘ TURN æœåŠ¡å™¨å‘é€ Allocation æŒ‡ä»¤è·å¾—åœ¨ relay æœåŠ¡å™¨ä¸Šçš„ç«¯å£ï¼Œç”¨äºä¸­è½¬ UDP æ•°æ®ã€‚

> æ€»ç»“ä¸Šé¢çš„å†…å®¹ï¼ŒWebRTC çš„é€šä¿¡åŒæ–¹åœ¨è¿›è¡Œé“¾æ¥ä¹‹å‰ä¼šæŒ‰ç…§ä¼˜å…ˆçº§æ”¶é›†é“¾æ¥çš„å€™é€‰è€…ï¼ŒæŒ‰ç…§ä¼˜å…ˆçº§çš„é«˜ä½ï¼Œåˆ†åˆ«æ˜¯ï¼šåœ¨æœ¬çº§æ”¶é›†æ‰€æœ‰çš„ host ç±»å‹çš„å€™é€‰è€…è¿›è¡Œå†…ç½‘é“¾æ¥ï¼Œé€šè¿‡ STUN åè®®æ”¶é›† srflx å€™é€‰è€…è¿›è¡Œ P2P é“¾æ¥ï¼Œé€šè¿‡ TURN åè®®æ”¶é›† relay å€™é€‰è€…é€šè¿‡ä¸­è½¬æœåŠ¡å™¨é“¾æ¥å¹¶ä¼ è¾“ UDP æ•°æ®ã€‚

å¾ˆæ˜¾ç„¶è¿™ç§æ–¹å¼æ˜¯å¼€é”€å¾ˆå¤§çš„ï¼Œæ‰€ä»¥åªæœ‰åœ¨æ²¡å¾—é€‰æ‹©çš„æƒ…å†µä¸‹é‡‡ç”¨ã€‚

[åè®®åœ°å€](https://www.rfc-editor.org/rfc/rfc7065)

![](https://assets.fedtop.com/picbed/202211272053218.png)

ä¸€èˆ¬æˆ‘ä»¬éƒ½ä¼šé€šè¿‡ [coturn](https://github.com/coturn/coturn)ä¼š[restund](https://creytiv.com/restund.html)æ¥æ­å»º `STUN` å’Œ `TURN` æœåŠ¡ã€‚éå¸¸çš„æ–¹ä¾¿ï¼Œæˆ‘ä½¿ç”¨çš„æ˜¯å¼€æºç¤¾åŒºæä¾›çš„ `coturn`ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ¯”è¾ƒæˆç†Ÿçš„é¡¹ç›®ã€‚æˆ‘ä¼šåœ¨ç¬¬ 4,5 ç¯‡æ–‡ç« è®²åˆ°å¦‚ä½•æ­å»ºå®ƒï¼Œè¿™ç¯‡æˆ‘ä»¬ç›´æ¥ç”¨ç°æˆçš„ `STUN` æœåŠ¡å°±è¡Œã€‚è‡³äº `TURN`æœåŠ¡...ğŸ¥² ç›®å‰æˆ‘è¿˜æ²¡æœ‰ä¸€ä¸ªæ¯”è¾ƒå¥½çš„æœåŠ¡å™¨ï¼Œèƒ½é¡¶å¾—ä½è¿™ç§ï¼Œæˆ‘åé¢çœ‹çœ‹æä¸€å°åˆé€‚çš„è¿‡æ¥æ­å»ºä¸€ä¸ªï¼Œä¾›å¤§å®¶åœ¨çº¿ä½“éªŒä¸€ä¸‹ã€‚

æ‰€ä»¥è¿™ç¯‡æ–‡ç« æˆ‘ä»¬åšçš„ demo å¯ä»¥åœ¨å†…ç½‘ï¼Œä»¥åŠç½‘ç»œç¯å¢ƒä¸æ˜¯ç‰¹åˆ«å¤æ‚çš„å¤–ç½‘ä¸‹è¿›è¡ŒéŸ³è§†é¢‘é€šè¯ã€‚ï¼ˆä¸€æ–¹ä½äº NAT ç½‘ç»œå†…éƒ¨ï¼Œæˆ–è€…åŒæ–¹éƒ½åœ¨ `éå¯¹ç§°NAT`ç½‘ç»œå†…çš„æƒ…å†µï¼‰

## ä»€ä¹ˆå«ä¿¡ä»¤ï¼Ÿ

æˆ‘ä»¬çŸ¥é“ `WebRTC` æƒ³è¦ç›´æ¥é€šè¿‡ `P2P` è¿æ¥è¿›è¡Œé€šä¿¡ï¼Œéœ€è¦ä¸€ä¸ªä¸­ç»§çš„è¿‡ç¨‹(åœ¨ä¸¤ä¸ªç»ˆç«¯ä¹‹é—´ä¼ é€’æ§åˆ¶ä¿¡æ¯çš„è¿‡ç¨‹)ï¼Œè¿™ä¸ªä¸­ç»§çš„è¿‡ç¨‹å°±ç§°ä¹‹ä¸º`ä¿¡ä»¤`ã€‚  
æ‰€ä»¥ç®€å•æ¥è¯´ï¼Œä¿¡ä»¤å°±æ˜¯åœ¨ä¸¤ä¸ªè®¾å¤‡ä¹‹é—´å‘é€æ§åˆ¶ä¿¡æ¯ä»¥ç¡®å®šé€šä¿¡åè®®ã€ä¿¡é“ã€åª’ä½“ç¼–è§£ç å™¨å’Œæ ¼å¼ä»¥åŠæ•°æ®ä¼ è¾“æ–¹æ³•ä»¥åŠä»»ä½•æ‰€éœ€çš„è·¯ç”±ä¿¡æ¯çš„è¿‡ç¨‹ï¼Œè€Œæ‰§è¡Œæ­¤æ“ä½œçš„æœåŠ¡å™¨ç§°ä¸º`ä¿¡ä»¤æœåŠ¡å™¨`ã€‚

ä¿¡ä»¤æœåŠ¡å™¨æŒ‰ç…§ä¸èŠå¤©å®¤ç›¸åŒçš„æ–¹å¼å¯¹è¿æ¥çš„èŠ‚ç‚¹è¿›è¡Œé€»è¾‘åˆ†ç»„ï¼Œå¹¶å¸®åŠ©å„ç«¯ç›¸äº’äº¤æ¢ `SDP` ç­‰ä¿¡æ¯ã€‚

![](https://assets.fedtop.com/picbed/202211271715310.png)

> å…³äº WebRTC çš„ä¿¡ä»¤æµç¨‹æœ€é‡è¦çš„ä¸€ç‚¹æ˜¯ï¼š **ã€Œä¿¡ä»¤åœ¨è§„èŒƒä¸­å¹¶æ²¡æœ‰å®šä¹‰ã€** æ‰€ä»¥å¼€å‘è€…éœ€è¦è‡ªå·±å†³å®šå¦‚ä½•å®ç°è¿™ä¸ªè¿‡ç¨‹ã€‚å¼€å‘è€…å¯ä»¥ä¸ºåº”ç”¨ç¨‹åºå¼•æ“é€‰æ‹©ä»»æ„çš„ä¿¡æ¯åè®®ï¼ˆå¦‚ SIP æˆ– XMPPï¼‰ï¼Œä»»æ„åŒå‘é€šä¿¡ä¿¡é“ï¼ˆå¦‚ WebSocket æˆ– XMLHttpRequest) ä¸æŒä¹…è¿æ¥æœåŠ¡å™¨çš„ APIï¼ˆå¦‚ Google Channel APIï¼‰ä¸€èµ·å·¥ä½œã€‚

æ ¹æ®ä¸Šé¢çš„è¯´æ˜æˆ‘ä»¬å°±å¯ä»¥çŸ¥é“ä¿¡ä»¤æœåŠ¡å™¨çš„å®ç°æ–¹å¼æœ‰å¾ˆå¤šç§ï¼Œå¯ä»¥æ ¹æ®è¦å¼€å‘çš„æœåŠ¡çš„æ€§è´¨ä½¿ç”¨ç°æœ‰çš„ä¿¡ä»¤åè®®ï¼Œä¹Ÿå¯ä»¥é€šè¿‡è½®è¯¢/é•¿è½®è¯¢æˆ– websocket ç­‰é€‚å½“çš„åŒå‘é€šä¿¡é€šé“æ¥å®ç°ã€‚

ç”±äºä¿¡ä»¤çš„æ ¸å¿ƒæ˜¯äº¤æ¢å¼‚æ­¥å‘é€çš„å¯¹ç­‰ä¿¡æ¯ï¼ˆSDPï¼ŒCandidateï¼‰ã€‚å› æ­¤ï¼Œå°†å…¶å®ç°ä¸ºæ”¯æŒå…¨åŒå·¥é€šä¿¡çš„ websocket æœ€ä¸ºåˆé€‚ã€‚ä¸‹é¢æˆ‘é¢ä¼šé€šè¿‡ socket.io æ¥å®ç°ä¸€ä¸ªç®€å•çš„ä¿¡ä»¤æœåŠ¡å™¨ã€‚

æœ‰ç‚¹åƒæ‘é‡Œç›¸äº²çš„ï¼Œä¸€å¼€å§‹ä¸è®¤è¯†å¯¹æ–¹ï¼Œæ²¡æ³•ç›´æ¥è”ç³»ï¼Œéœ€è¦é€šè¿‡åª’ä»‹ï¼Œä¸­é—´äººæ¥ä¼ é€’æ¶ˆæ¯åï¼Œä½ ä»¬å¯èƒ½çŸ¥é“å¯¹æ–¹çš„ä½ç½®å•Šï¼Œè”ç³»æ–¹å¼å•Šç­‰ç­‰æ‰èƒ½å¾ˆå¥½çš„ç›´æ¥å»ºç«‹è”ç³»ã€‚

![](https://assets.fedtop.com/picbed/202211220923424.png)

![](https://assets.fedtop.com/picbed/202211132222279.png)

è¿™å¼ å›¾å¾ˆæ¸…æ¥šçš„æè¿°äº†è¿™ä¸ªè¿‡ç¨‹ã€‚

å„ç«¯é€šè¿‡ä¿¡ä»¤æœåŠ¡å™¨äº¤æ¢ `SDP` ä¿¡æ¯ï¼Œç„¶åå„ç«¯é€šè¿‡ `P2P` è¿æ¥è¿›è¡Œé€šä¿¡ã€‚

å…³äºä¿¡ä»¤æ›´å¤šçš„è¯¦ç»†å†…å®¹å¯ä»¥å‚è€ƒï¼š[MDN ä¿¡ä»¤çš„ä»‹ç»](https://developer.mozilla.org/zh-CN/docs/Web/API/WebRTC_API/Session_lifetime#%E4%BF%A1%E4%BB%A4)ï¼Œ[MDN ä¿¡ä»¤ä¸è§†é¢‘é€šè¯](https://developer.mozilla.org/zh-CN/docs/Web/API/WebRTC_API/Signaling_and_video_calling)

## ä¿¡ä»¤æœåŠ¡å™¨çš„å…·ä½“å®ç°

ä¸‹é¢æˆ‘ä»¬ä¸»è¦ä½¿ç”¨ `socket.io` æ¥å®ç°ä¸€ä¸ªç®€å•çš„ä¿¡ä»¤æœåŠ¡å™¨ã€‚

ä¸ºä»€ä¹ˆä½¿ç”¨å®ƒå‘¢ï¼Ÿ

å°±åƒ Axios æ˜¯å¯¹ XMLHttpRequest çš„å°è£…ï¼Œ è€Œ Socket.io å°±æ˜¯å¯¹ WebSocket çš„å°è£…ï¼Œå¹¶ä¸”å®ç°äº† WebSocket çš„æœåŠ¡ç«¯ä»£ç ã€‚Socket.IO å°† WebSocket å’Œè½®è¯¢ï¼ˆPollingï¼‰æœºåˆ¶ä»¥åŠå…¶å®ƒçš„å®æ—¶é€šä¿¡æ–¹å¼å°è£…æˆäº†é€šç”¨çš„æ¥å£ï¼Œå¹¶ä¸”åœ¨æœåŠ¡ç«¯å®ç°äº†è¿™äº›å®æ—¶æœºåˆ¶çš„ç›¸åº”ä»£ç ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒWebSocket ä»…ä»…æ˜¯ Socket.IO å®ç°å®æ—¶é€šä¿¡çš„ä¸€ä¸ªå­é›†ã€‚Socket.IO ç®€åŒ–äº† WebSocket APIï¼Œç»Ÿä¸€äº†è¿”å›ä¼ è¾“çš„ APIã€‚

æ€»ç»“ä¸€ä¸‹å°±æ˜¯ï¼š

![](https://assets.fedtop.com/picbed/202211272137175.png)

ç”¨å®ƒæ¥å†™éå¸¸çš„ç®€å•æ–¹ä¾¿ï¼Œä¸‹é¢æˆ‘ä»¬å°±ç”¨ express é…åˆ socket.io æ¥å®ç°ä¸€ä¸ªç®€å•çš„ä¿¡ä»¤æœåŠ¡å™¨ã€‚

### ä¿¡ä»¤æœåŠ¡çš„æ­å»º

æˆ‘ä»¬ç”¨ nodejs æ¥å†™æœåŠ¡ç«¯ï¼Œé¦–å…ˆæˆ‘ä»¬è¦å®‰è£…ä¸€ä¸‹ `socket.io`

```bash
# æœåŠ¡ç«¯
npm i express socket.io
```

ç„¶åæˆ‘ä»¬åˆ›å»ºä¸€ä¸ª `server.js` æ–‡ä»¶ï¼Œç”¨æ¥å¯åŠ¨ä¸€ä¸ªæ²¡æœ‰ä¸šåŠ¡é€»è¾‘çš„ä¿¡ä»¤æœåŠ¡ã€‚

```js
import http from 'http'
import { Server } from 'socket.io'
import express from 'express'

const port = 3000
const app = express()
const httpServer = http.createServer(app)
// åˆ›å»ºä¿¡ä»¤æœåŠ¡å™¨
const io = new Server(httpServer, {
  cors: {
    origin: '*', // å…è®¸è·¨åŸŸ
    methods: ['GET', 'POST'], // å…è®¸çš„è¯·æ±‚æ–¹å¼
    allowedHeaders: '*', // å…è®¸çš„è¯·æ±‚å¤´
    credentials: true, // å…è®¸æºå¸¦cookie
  },
  allowEIO3: true, // æ˜¯å¦å¯ç”¨ä¸Socket.IO v2å®¢æˆ·ç«¯çš„å…¼å®¹æ€§
  transport: ['websocket'], // ä»…å…è®¸websocket,["polling", "websocket"]
})

// åœ¨æŒ‡å®šç«¯å£å¯åŠ¨æœåŠ¡å™¨
httpServer.listen(port, () => {
  console.log('\n Http server up and running at => http://%s:%s', httpServer.address().address, httpServer.address().port)
})

// ç›‘å¬ç”¨æˆ·è¿æ¥
io.on('connection', (socket) => {
  console.log('connection~')

  // ç›‘å¬è¿æ¥æ–­å¼€
  socket.on('disconnect', () => {
    console.log('disconnect~')
  })
})
```

è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨äº† `express` æ¥åˆ›å»ºä¸€ä¸ªç®€å•çš„æœåŠ¡ï¼Œç„¶åä½¿ç”¨ `socket.io` æ¥åˆ›å»ºä¸€ä¸ª websocket æœåŠ¡ã€‚

è¿™æ ·ä¸€ä¸ª ç®€å• websocket æœåŠ¡æ¶å­å°±æ­å¥½äº†ã€‚æˆ‘ä»¬å…ˆå¯åŠ¨è¿™ä¸ªæœåŠ¡.

```bash
node server.js
```

æ˜¯ä¸æ˜¯å¾ˆç®€å•~~

### å®¢æˆ·ç«¯éœ€è¦åšçš„äº‹æƒ…

ç„¶åæˆ‘ä»¬åœ¨å®¢æˆ·ç«¯ä¹Ÿè¦å®‰è£…é…å¥—çš„ `socket.io-client`

```bash
# å®¢æˆ·ç«¯
npm i socket.io-client
```

ç„¶åæˆ‘ä»¬åœ¨å®¢æˆ·ç«¯ä»£ç ä¸­å¼•å…¥ `socket.io-client`ï¼Œå¹¶ä¸”è¿æ¥åˆ°æˆ‘ä»¬åˆšå¯åŠ¨çš„ä¿¡ä»¤æœåŠ¡ã€‚

```js
import io from 'socket.io-client'

// è¿æ¥åˆ°ä¿¡ä»¤æœåŠ¡
const socket = io('http://localhost:3000')
```

ç”±äº WebRTC æ˜¯éœ€è¦åœ¨ `https` åè®®ä¸‹æ‰èƒ½ä½¿ç”¨çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åœ¨æœ¬åœ°ç”Ÿæˆä¸€ä¸ª è‡ªç­¾åçš„`https` è¯ä¹¦ã€‚ï¼ˆå½“ç„¶ï¼Œä½ å®¢æˆ·ç«¯ç›´æ¥åœ¨ localhost ä¸‹æµ‹è¯•å°±ä¸éœ€è¦é€šè¿‡ https äº†ï¼‰ã€‚

è¦ä¸ç„¶ï¼Œä½ åœ¨ https åè®®çš„é¡µé¢ï¼Œè¯·æ±‚ http èµ„æºæ—¶ï¼Œæµè§ˆå™¨ä¼šæŠ¥é”™ï¼Œå› ä¸º https é¡µé¢ä¸­çš„èµ„æºå¿…é¡»æ˜¯ https çš„ï¼Œå¦åˆ™æµè§ˆå™¨ä¼šé˜»æ­¢åŠ è½½ã€‚

httpsï¼Œå¯¹åº”çš„æˆ‘ä»¬ä¿¡ä»¤æœåŠ¡çš„åœ°å€ä¹Ÿéœ€è¦æ˜¯ httpsï¼Œä¸ç„¶å°±ä¼šæŠ¥é”™

![](https://assets.fedtop.com/picbed/202209152158537.png)

æ‰€ä»¥ä¸‹é¢æˆ‘ä»¬éœ€è¦è‡ªç­¾ä¸€å¼ è¯ä¹¦ã€‚

## è‡ªç­¾è¯ä¹¦

æˆ‘ä»¬å¯ä»¥é€šè¿‡ openssl ç”Ÿæˆè‡ªç­¾è¯ä¹¦ï¼Œå¹¶å°†å…¶ä¿å­˜åœ¨æœ¬åœ°ã€‚æˆ‘ä¸€ç›´è§‰å¾—ç”¨ OpenSSL å¼„å¥½éº»çƒ¦ï¼Œè¿™é‡Œæˆ‘ä½¿ç”¨ mkcertï¼Œå®ƒä½œä¸ºæœ¬åœ° https çš„å¿«é€Ÿè§£å†³æ–¹æ¡ˆï¼Œç”¨èµ·æ¥éå¸¸æ–¹ä¾¿ã€‚

> [mkcert](https://github.com/FiloSottile/mkcert) æ˜¯ä¸€ä¸ªç”¨ Go è¯­è¨€ç¼–å†™çš„å·¥å…·ï¼Œå®ƒå¯ä»¥è½»æ¾åœ°ä¸ºæœ¬åœ°å¼€å‘ç”Ÿæˆæœ‰æ•ˆçš„ TLS è¯ä¹¦ã€‚å®ƒä½¿ç”¨äº†ä¸€ä¸ªåä¸º local CA çš„æ ¹è¯ä¹¦ï¼Œè¿™ä¸ªæ ¹è¯ä¹¦æ˜¯ç”± mkcert ç”Ÿæˆçš„ï¼Œå®ƒä¼šè¢«å®‰è£…åˆ°ç³»ç»Ÿçš„å—ä¿¡ä»»çš„æ ¹è¯ä¹¦åˆ—è¡¨ä¸­ã€‚

ä¸‹é¢ä¸€èµ·æ¥é€šè¿‡ mkcert ç”Ÿæˆè‡ªç­¾è¯ä¹¦ï¼Œå¹¶å°†å…¶ä¿å­˜åœ¨æœ¬åœ°ã€‚

### å®‰è£… mkcert å¹¶ç”Ÿæˆè¯ä¹¦

æˆ‘è¿™è¾¹ä½¿ç”¨çš„æ˜¯ macos ï¼Œå®‰è£…èµ·æ¥å¾ˆæ–¹ä¾¿ï¼Œå…¶ä»–ç³»ç»Ÿçš„å®‰è£…æ–¹å¼å¯ä»¥å‚è€ƒ [mkcert æ–‡æ¡£](https://github.com/FiloSottile/mkcert),[æœ¬åœ° https å¿«é€Ÿè§£å†³æ–¹æ¡ˆâ€”â€”mkcert](https://blog.dteam.top/posts/2019-04/%E6%9C%AC%E5%9C%B0https%E5%BF%AB%E9%80%9F%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88mkcert.html)ï¼ŒåŸºæœ¬éƒ½å·®ä¸å¤š

```sh
# å®‰è£… mkcert
brew install mkcert
# å®‰è£…å®Œæˆåï¼Œæ‰§è¡Œâ†“
mkcert -install
```

å®‰è£…å®Œæˆåï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ mkcert ç”Ÿæˆè‡ªç­¾è¯ä¹¦äº†ï¼Œè¿™é‡Œæˆ‘ç”Ÿæˆäº†ä¸€ä¸ªåä¸º localhost çš„è¯ä¹¦ï¼Œè¯ä¹¦ä¿å­˜åœ¨å½“å‰ç›®å½•ä¸‹ã€‚

ç”Ÿæˆè¯ä¹¦ä¹Ÿå¾ˆç®€å•ï¼Œå°±ä¸€è¡Œå‘½ä»¤

```sh
# mkcert domain1 [domain2 [...]]

# æœ¬åœ°çš„ç›´æ¥è¿™æ ·å°±ok
mkcert localhost 127.0.0.1 ::1
```

ç”Ÿæˆçš„è¯ä¹¦åŒ…å«ä¸¤ä¸ªæ–‡ä»¶ï¼Œä¸€ä¸ªæ˜¯è¯ä¹¦æ–‡ä»¶ï¼Œä¸€ä¸ªæ˜¯ç§é’¥æ–‡ä»¶ï¼Œè¿™ä¸¤ä¸ªæ–‡ä»¶éƒ½æ˜¯å¿…é¡»çš„ï¼Œå› ä¸ºè¯ä¹¦æ–‡ä»¶æ˜¯å…¬å¼€çš„ï¼Œè€Œç§é’¥æ–‡ä»¶æ˜¯ç§æœ‰çš„ï¼Œå®ƒä»¬æ˜¯ä¸€å¯¹ã€‚

```sh
localhost.pem
localhost-key.pem
```

ç”Ÿæˆå®Œæ¯•åï¼Œä¸ç®¡ä½ æ˜¯åœ¨ nginx ä¸­ä½¿ç”¨è¿˜æ˜¯åœ¨ node ä¸­ä½¿ç”¨ï¼Œåªéœ€è¦å°†åœ¨ nginx æˆ–è€… node ä¸­æŒ‡å®šè¯ä¹¦æ–‡ä»¶å’Œç§é’¥æ–‡ä»¶çš„è·¯å¾„å³å¯ã€‚

![](https://assets.fedtop.com/picbed/202211231156906.png)

### node ä¸­ä½¿ç”¨

```js
import { Server } from 'socket.io'
import express from 'express'
import https from 'https'
import path from 'path'
import { fileURLToPath } from 'url'
import fs from 'fs'

const __filename = fileURLToPath(import.meta.url)
const __dirname = path.dirname(__filename)

//httpsè¯ä¹¦
const options = {
  cert: fs.readFileSync(path.join(__dirname, '../assets/localhost.pem')),
  key: fs.readFileSync(path.join(__dirname, '../assets/localhost-key.pem')),
}
const app = express()
const httpsServer = https.createServer(options, app)

httpsServer.listen(3333, '0.0.0.0', () => {
  console.log('Https server up and running...')
})
```

### nginx ä¸­ä½¿ç”¨

åœ¨æœ¬åœ°æµ‹è¯•çš„è¯æ€ä¹ˆæ ·éƒ½è¡Œï¼Œåˆ°çº¿ä¸Šç¯å¢ƒçš„æ—¶å€™ï¼Œå¯ä»¥å»å„å¤§äº‘æœåŠ¡å•†ç”³è¯·è¯ä¹¦ï¼Œä¸Šä¼ åˆ°æœåŠ¡å™¨å’Œè‡ªç­¾çš„è¯ä¹¦ä¸€æ ·ä½¿ç”¨å°±è¡Œäº†ï¼Œè¿™å—å°±ä¸å¤šè¯´äº†ã€‚

(éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œip è¯ä¹¦éå¸¸çš„è´µï¼Œä¸€èˆ¬éƒ½æ˜¯ç›´æ¥ç”¨ä¸€ä¸ªåŸŸåè¯ä¹¦ï¼Œç„¶åé€šè¿‡ nginx åšè½¬å‘)

![](https://assets.fedtop.com/picbed/202211230136032.png)  
æˆ–è€…ä½ åªæ˜¯æƒ³åœ¨çº¿ä¸Šæµ‹è¯•çš„è¯ï¼Œä¹Ÿä¸€æ ·é€šè¿‡ mkcert å·¥å…·æ¥ç”Ÿæˆæœ¬åœ°çš„è‡ªç­¾ HTTPS è¯ä¹¦å°±è¡Œäº†ï¼Œåªä¸è¿‡è¿™ä¸ªè¯ä¹¦æµè§ˆå™¨ä¼šæç¤ºä¸å®‰å…¨ï¼Œä½†æ˜¯ç”¨æ¥æµ‹è¯•è¿˜æ˜¯å¯ä»¥çš„ã€‚

```sh
server {
    #SSL é»˜è®¤è®¿é—®ç«¯å£å·ä¸º 443
    listen 12345 ssl;
    #è¯·å¡«å†™è¯ä¹¦æ–‡ä»¶çš„ç›¸å¯¹è·¯å¾„æˆ–ç»å¯¹è·¯å¾„
    ssl_certificate /path/to/localhost.pem;
    #è¯·å¡«å†™ç§é’¥æ–‡ä»¶çš„ç›¸å¯¹è·¯å¾„æˆ–ç»å¯¹è·¯å¾„
    ssl_certificate_key /path/to/localhost-key.pem;
    #è¯·å¡«å†™ç»‘å®šè¯ä¹¦çš„åŸŸå
    server_name localhost;

    location / {
      proxy_pass http://localhost:3000;

      # ä¸ºäº†è®©ä»£ç†æœåŠ¡å™¨äº†è§£å®¢æˆ·ç«¯å°†åè®®åˆ‡æ¢åˆ° WebSocket çš„æ„å›¾ï¼Œä¸‹é¢ä¸‰ä¸ªæ ‡å¤´å¿…é¡»åŠ ä¸Š
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection 'upgrade';

      # http://nginx.org/en/docs/http/websocket.html
      # https://echizen.github.io/tech/2018/10-21-nginx-websocket
    }
}
```

### å®¢æˆ·ç«¯ä½¿ç”¨

æ¯”å¦‚æˆ‘è¿™è¾¹ç”¨ vite åˆ›å»ºçš„é¡¹ç›®ï¼Œæˆ‘åœ¨ vite.config.ts ä¸­è¦é…ç½® httpsï¼Œç›´æ¥æŒ‰ç…§ä¸‹é¢çš„ä»£ç é…ç½®å°±è¡Œäº†ã€‚å…¶ä»–è„šæ‰‹æ¶ç”Ÿæˆçš„é¡¹ç›®ä¹Ÿæ˜¯ç±»ä¼¼çš„ã€‚

```typescript
// https://vitejs.dev/config/
import * as fs from 'fs'

export default defineConfig((config) => ({
  // é…ç½®ä¸»æœºã€ç«¯å£ã€httpsâ€¦
  server: {
    https: {
      key: fs.readFileSync(`${__dirname}/localhost-key.pem`),
      cert: fs.readFileSync(`${__dirname}/localhost.pem`),
    },
  },
}))
```

ok, åˆ°è¿™é‡Œï¼Œé“ºå«å·¥ä½œå°±å®Œæˆäº†ï¼Œä¸‹é¢æˆ‘ä»¬å°±å¯ä»¥æ­£å¼å¼€å§‹å†™å‰åç«¯çš„ç›¸å…³é€»è¾‘äº†ã€‚

## ä¿¡ä»¤æœåŠ¡çš„é€»è¾‘å®ç°

è¿˜è®°çš„æˆ‘ä»¬ä¸Šä¸€ç¯‡æ–‡ç« ä¸­æ˜¯å¦‚ä½•å®ç° p2p é€šä¿¡çš„å—ï¼Ÿ

æˆ‘ä»¬é€šè¿‡æ‰‹åŠ¨ä¼ è¾“æœ¬åœ°å’Œè¿œç¨‹çš„ `SDP`ç­‰ä¿¡æ¯æ¥å®ç° P2P é€šä¿¡ï¼Œæ‰€ä»¥è¿™æ¬¡æˆ‘ä»¬åªéœ€è¦æŠŠè¿™ä¸ªè¿‡ç¨‹äº¤ç»™ socket æœåŠ¡æ¥å¤„ç†å°±è¡Œäº†ã€‚

é¦–å…ˆæˆ‘ä»¬éœ€è¦å®‰è£…å¹¶å¼•å…¥ `socket.io-client`ï¼Œç„¶åè¿æ¥åˆ°æˆ‘ä»¬ä¸Šä¸€å°èŠ‚å¯åŠ¨çš„ä¿¡ä»¤æœåŠ¡ã€‚

```typescript
import io from 'socket.io-client'
const socket = io('https://localhost:3000')
```

ç„¶åæˆ‘ä»¬éœ€è¦ç›‘å¬ä¸€äº›æœåŠ¡ç«¯çš„äº‹ä»¶ï¼Œè¿™ä¸ªæˆ‘ä»¬æ ¹æ®å…·ä½“éœ€æ±‚æ¥å®šä¹‰ã€‚

socket.io æœ€ä¸»è¦çš„å°±æ˜¯ `on` å’Œ `emit` ä¸¤ä¸ªæ–¹æ³•ï¼Œåœ¨å®¢æˆ·ç«¯ `on` ç”¨æ¥ç›‘å¬æœåŠ¡ç«¯çš„äº‹ä»¶ï¼Œ`emit` ç”¨æ¥è§¦å‘æœåŠ¡ç«¯çš„äº‹ä»¶ã€‚åœ¨æœåŠ¡ç«¯ `on` ç”¨æ¥ç›‘å¬å®¢æˆ·ç«¯çš„äº‹ä»¶ï¼Œ`emit` ç”¨æ¥è§¦å‘å®¢æˆ·ç«¯çš„äº‹ä»¶ã€‚è¿˜æœ‰ä¸€äº›å…¶ä»–çš„ api æˆ‘ä»¬ç›´æ¥å¯¹ç€æ–‡æ¡£æ¥å°±è¡Œï¼Œæ‰€ä»¥è¯´å®ƒä½¿ç”¨èµ·æ¥éå¸¸çš„ç®€å•ã€‚

### å®šä¹‰å®¢æˆ·ç«¯éœ€è¦ç›‘å¬çš„äº‹ä»¶

okï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹æˆ‘ä»¬éœ€è¦ç›‘å¬çš„äº‹ä»¶ã€‚

```typescript
// è¿æ¥æˆåŠŸæ—¶è§¦å‘
socket.on('connect', () => {
  handleConnect()
})

// æ–­å¼€è¿æ¥æ—¶è§¦å‘
socket.on('disconnect', (reason) => {
  if (reason === 'io server disconnect') {
    // æ–­çº¿æ˜¯ç”±æœåŠ¡å™¨å‘èµ·çš„ï¼Œé‡æ–°è¿æ¥ã€‚
    socket.connect()
  }
  ElMessage.warning('æ‚¨å·²æ–­å¼€è¿æ¥')
})
// æœåŠ¡ç«¯å‘é€æŠ¥é”™ä¿¡æ¯
socket.on('error', (data) => {
  ElMessage.error(data)
})
// å½“æœ‰ç”¨æˆ·åŠ å…¥æˆ¿é—´æ—¶è§¦å‘
socket.on('welcome', (data) => {
  ElMessage.success(data.userId === userId ? 'ğŸ¦„æˆåŠŸåŠ å…¥æˆ¿é—´' : `ğŸ¦„${data.userId}åŠ å…¥æˆ¿é—´`)
})
// å½“æœ‰ç”¨æˆ·ç¦»å¼€æˆ¿é—´æ—¶è§¦å‘
socket.on('leave', (data) => {
  ElMessage.warning(data.userId === userId ? 'ğŸ¦„æˆåŠŸç¦»å¼€æˆ¿é—´' : `ğŸ¦„${data.userId}ç¦»å¼€æˆ¿é—´`)
})
// å½“æœ‰ç”¨æˆ·å‘é€æ¶ˆæ¯æ—¶è§¦å‘
socket.on('message', (data) => {})
// åˆ›å»ºoffer,å‘é€ç»™è¿œç«¯
socket.on('createOffer', (data) => {
  // å¦‚æœå·²ç»åˆ›å»ºè¿‡ï¼Œç›´æ¥å‘é€
  if (offerSdp) {
    socket.emit('offer', {
      userId,
      roomId: roomId.value,
      sdp: offerSdp,
    })
    return
  }
  createOffer() // åˆ›å»º offer
})
// æ”¶åˆ°offer,åˆ›å»ºanswer
socket.on('offer', (data) => {
  createAnswer(data.sdp)
})
// æ”¶åˆ°answer,è®¾ç½®è¿œç«¯sdp
socket.on('answer', (data) => {
  addAnswer(data.sdp)
})
```

å½“ç„¶ä½ ä¹Ÿå¯ä»¥æ ¹æ®è‡ªå·±çš„ä¹ æƒ¯ç›´æ¥æŠŠæ‰€æœ‰äº‹ä»¶éƒ½åŒ…åœ¨ `socket.on('message',(data)=>{})` é‡Œï¼Œdata é‡ŒåŠ å¥½ type å°±è¡Œï¼Œè¿™æ ·åªéœ€è¦ä¿ç•™å‡ ä¸ªå…³é”®äº‹ä»¶ï¼Œå…¶ä½™çš„éƒ½èµ° message äº‹ä»¶çš„é€»è¾‘ã€‚

### å®šä¹‰ä¿¡ä»¤æœåŠ¡ç«¯éœ€è¦ç›‘å¬çš„äº‹ä»¶

```javascript
// ç”¨æˆ·è¿æ¥
io.on('connection', (socket) => {
  console.log('connection~')
  // ç”¨æˆ·åŠ å…¥æˆ¿é—´
  socket.on('join', (data) => {
    console.log('join~', data)
    handleUserJoin(socket, data)
  })
  // ç”¨æˆ·ç¦»å¼€æˆ¿é—´
  socket.on('leave', (data) => {
    console.log('leave', data)
    handleUserDisconnect(socket)
  })
  // ç›‘å¬è¿æ¥æ–­å¼€
  socket.on('disconnect', () => {
    console.log('disconnect~')
    handleUserDisconnect(socket)
  })
  //=============================
  // ç”¨æˆ·å‘é€ offer
  socket.on('offer', (data) => {
    socket.to(data.roomId).emit('offer', data)
  })
  // ç”¨æˆ·å‘é€ answer
  socket.on('answer', (data) => {
    socket.to(data.roomId).emit('answer', data)
  })
  // ç”¨æˆ·å‘é€æ¶ˆæ¯
  socket.on('message', (data) => {
    console.log('message', data)
  })
})
```

### å®¢æˆ·ç«¯åŠ å…¥æˆ¿é—´

æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦å®ç°å®¢æˆ·ç«¯åŠ å…¥æˆ¿é—´çš„é€»è¾‘ï¼Œè¿™ä¸ªé€»è¾‘å…¶å®å°±æ˜¯å‘Šè¯‰æœåŠ¡ç«¯ï¼Œæˆ‘è¦åŠ å…¥æŸä¸ªæˆ¿é—´ï¼Œç„¶åæœåŠ¡ç«¯ä¼šæŠŠæˆ‘è¿™ä¸ªæˆ¿é—´çš„å…¶ä»–å®¢æˆ·ç«¯çš„ä¿¡æ¯å‘Šè¯‰æˆ‘ã€‚

```typescript
// éšæœºä¸€ä¸ªç”¨æˆ·åï¼Œåé¢ä½ å¯ä»¥è‡ªå·±æ”¹æˆè¾“å…¥æ¡†è®©ç”¨æˆ·è¾“å…¥
const userId = Math.random().toString(36).substring(2)
// æˆ¿é—´å·ï¼Œè¿™é‡Œéšä¾¿å†™ä¸€ä¸ªï¼Œåé¢ä½ å¯ä»¥è‡ªå·±æ”¹æˆè¾“å…¥æ¡†è®©ç”¨æˆ·è¾“å…¥
const roomId = 123

// åŠ å…¥æˆ¿é—´
function joinRoom() {
  socket.emit('join', { userId, roomId })
}
```

### æœåŠ¡ç«¯æ¥æ‰‹å®¢æˆ·ç«¯åŠ å…¥æˆ¿é—´çš„é€»è¾‘

æœåŠ¡ç«¯æ¥æ‰‹å®¢æˆ·ç«¯åŠ å…¥æˆ¿é—´çš„é€»è¾‘ï¼Œå…¶å®å°±æ˜¯æŠŠå®¢æˆ·ç«¯çš„ä¿¡æ¯ä¿å­˜åˆ°æœåŠ¡ç«¯çš„å†…å­˜ä¸­ï¼Œç„¶åæŠŠè¿™ä¸ªæˆ¿é—´çš„å…¶ä»–å®¢æˆ·ç«¯çš„ä¿¡æ¯å‘Šè¯‰å®¢æˆ·ç«¯ã€‚

```js
// æœåŠ¡ç«¯ï¼Œå½“ç”¨æˆ·åŠ å…¥æˆ¿é—´
socket.on('join', (data) => {
  handleUserJoin(socket, data)
})

// æˆ¿é—´ä¿¡æ¯
const ROOM_LIST = []
// æ¯ä¸ªæˆ¿é—´æœ€å¤šå®¹çº³çš„äººæ•°
const MAX_USER_COUNT = 2
// ç”¨æˆ·åŠ å…¥æˆ¿é—´
function handleUserJoin(socket, data) {
  const filterRoom = ROOM_LIST.filter((item) => item.roomId === data.roomId)[0]
  let room = { roomId: data.roomId, userList: [] }

  // åˆ¤æ–­æˆ¿é—´æ˜¯å¦å­˜åœ¨
  if (filterRoom) {
    room = filterRoom
  } else {
    ROOM_LIST.push(room)
  }

  // æ¯ä¸ªæˆ¿é—´äººæ•°ä¸è¶…è¿‡é¢„è®¾çš„äººæ•°
  if (room.userList.length >= MAX_USER_COUNT) {
    socket.emit('error', 'æˆ¿é—´äººæ•°å·²æ»¡ï¼Œè¯·ç¨åå†è¯•')
    return
  }

  // å½“æˆ¿é—´é‡Œçš„äººæ•°ä¸º0ä¸”ç®¡ç†å‘˜è¿˜æ²¡æœ‰è®¾ç½®ï¼Œè®¾ç½®ç®¡ç†å‘˜
  if (room.userList.length === 0) {
    room.admin = data.userId
  }

  // åˆ¤æ–­ç”¨æˆ·æ˜¯å¦å·²ç»åœ¨æˆ¿é—´é‡Œ
  if (room.userList.some((item) => item.userId === data.userId)) {
    socket.emit('error', 'ç”¨æˆ·å·²åœ¨æˆ¿é—´é‡Œ')
    return
  }
  // æŠŠç”¨æˆ·ä¿¡æ¯ä¿å­˜åˆ°æˆ¿é—´é‡Œ
  room.userList.push(data)
  console.log(data.userId, 'åŠ å…¥æˆ¿é—´')

  socket.userId = data.userId
  socket.roomId = data.roomId

  // å°†ç”¨æˆ·åŠ å…¥æˆ¿é—´
  socket.join(data.roomId)
  // é€šçŸ¥æˆ¿é—´å†…çš„å…¶ä»–ç”¨æˆ·
  socket.to(data.roomId).emit('welcome', data)
  // é€šçŸ¥è‡ªå·±åŠ å…¥æˆ¿é—´æˆåŠŸï¼Œ
  socket.emit('joined', data)
}
```

### å®¢æˆ·ç«¯åˆ›å»ºææ¡ˆ

è¿™é‡Œï¼Œæˆ‘ä»¬ä¸»è¦å¯¹ä¸Šä¸€ç¯‡åˆ›å»ºææ¡ˆçš„ä»£ç ä¸­æ·»åŠ  socket å‘é€çš„é€»è¾‘ï¼Œæˆ‘ä»¬éœ€è¦åœ¨å½“æœ‰ ICE å€™é€‰æ”¹å˜æ—¶ï¼Œå°†è¿™äº› æœ¬åœ°çš„ SDP æè¿°å‘é€åˆ°æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯å†å°†è¿™äº›ä¿¡æ¯è½¬å‘ç»™è¿œç¨‹çš„å®¢æˆ·ç«¯ã€‚è¿™é‡Œæˆ‘ä»¬å…ˆå†™å‘é€é€»è¾‘ï¼Œåé¢å†å»æœåŠ¡ç«¯å†™å¥½æ¥æ”¶é€»è¾‘å°±è¡Œã€‚

```typescript
// æˆåŠŸåŠ å…¥æˆ¿é—´
socket.on('joined', (room, id) => {
  ElMessage.success('ğŸ¦„ğŸ¦„ğŸ¦„æˆåŠŸåŠ å…¥æˆ¿é—´')
  createOffer()
})

// åˆ›å»º offer
async function createOffer() {
  // å½“ä¸€ä¸ªæ–°çš„offer ICEå€™é€‰äººè¢«åˆ›å»ºæ—¶è§¦å‘äº‹ä»¶
  peerConnection.onicecandidate = async (event) => {
    if (event.candidate) {
      offerSdp = JSON.stringify(peerConnection.localDescription)
      // å‘é€ offer
      if (offerSdp) {
        socket.emit('offer', {
          userId,
          roomId: roomId.value,
          sdp: offerSdp,
        })
      }
    }
  }
  const offer = await peerConnection.createOffer()
  await peerConnection.setLocalDescription(offer)
}
```

å…¶ä¸­çš„ `onicecandidate` äº‹ä»¶ï¼Œæ˜¯ç”¨æ¥ç›‘å¬ ICE æœåŠ¡å™¨è¿”å›çš„å€™é€‰åœ°å€ï¼Œå½“ ICE æœåŠ¡å™¨è¿”å›ä¸€ä¸ªæ–°çš„å€™é€‰åœ°å€æ—¶ï¼Œå°±ä¼šè§¦å‘è¯¥äº‹ä»¶ï¼Œè¿™é‡Œæˆ‘ä»¬é€šè¿‡ `socket.emit` å°†è¿™ä¸ªå€™é€‰åœ°å€å‘é€ç»™ä¿¡ä»¤æœåŠ¡ã€‚

å½“ä½ åœ¨åæœŸè¿æ¥æˆåŠŸçš„æ—¶å€™ï¼Œå…¶å®å¯ä»¥æŠŠ å€™é€‰äººä¿¡æ¯(candidate) æ‰“å°å‡ºæ¥å¯ä»¥çœ‹çœ‹ï¼Œå½“ä¸¤ä¸ªè®¾å¤‡åœ¨åŒä¸€ä¸ªå†…ç½‘ä¸­è¿æ¥çš„æ—¶å€™ï¼Œ candidate çš„åœ°å€ä¸ºä¸€ä¸ª ipv6 é•¿æ ¼å¼çš„å†…ç½‘åœ°å€å’Œä¸€ä¸ª ipv4 çš„å†…ç½‘åœ°å€ã€‚

![](https://assets.fedtop.com/picbed/202211272320557.png)

å½“ä¸¤ä¸ªè®¾å¤‡ä¸åœ¨åŒä¸€ä¸ªå†…ç½‘ä¸­è¿æ¥çš„æ—¶å€™ï¼Œå¯ä»¥çœ‹åˆ° candidate çš„åœ°å€æœ€åä¸ºä¸€ä¸ª ipv4 çš„å¤–ç½‘åœ°å€,è¯´æ˜å®ƒå°è¯•äº†ä¸¤æ¬¡è¿æ¥ï¼Œç¬¬ä¸€æ¬¡æ˜¯å†…ç½‘è¿æ¥ï¼Œç¬¬äºŒæ¬¡æ˜¯å¤–ç½‘è¿æ¥ã€‚è¯æ˜äº†å‰é¢è¯´çš„ä¸‰ç§ç±»å‹çš„å…ˆåè¿æ¥æ–¹å¼ã€‚

![](https://assets.fedtop.com/picbed/202211272328473.png)

### ä¿¡ä»¤æœåŠ¡ç«¯æ¥æ”¶ææ¡ˆ

æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦åœ¨æœåŠ¡ç«¯æ¥æ”¶åˆ°å®¢æˆ·ç«¯å‘é€çš„ææ¡ˆåï¼Œå°†è¿™ä¸ªææ¡ˆè½¬å‘ç»™è¿œç«¯çš„å®¢æˆ·ç«¯ã€‚

```typescript
// æ¥æ”¶ offer
socket.on('offer', (data) => {
  // console.log('offer', data)
  socket.to(data.roomId).emit('offer', data)
})
```

### å®¢æˆ·ç«¯æ¥æ”¶è¿œç¨‹çš„ææ¡ˆ

æ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦åœ¨å®¢æˆ·ç«¯æ¥æ”¶åˆ°è¿œç¨‹çš„ææ¡ˆåï¼Œå°†è¿™ä¸ªææ¡ˆè®¾ç½®æˆ RemoteDescriptionã€‚ç„¶ååˆ›å»ºåº”ç­”ï¼Œå°†åº”ç­”è®¾ç½®æˆæœ¬åœ°æè¿°ï¼Œåœ¨å€™é€‰äººä¿¡æ¯æ”¹å˜æ—¶ï¼Œå°†åº”ç­”å‘é€ç»™æœåŠ¡ç«¯ã€‚

```typescript
// åˆ›å»º answer
async function createAnswer(val: string) {
  const offer = JSON.parse(val)
  peerConnection.onicecandidate = async (event) => {
    // å½“ä¸€ä¸ªæ–°çš„ answer ICE candidate è¢«åˆ›å»ºæ—¶
    if (event.candidate) {
      socket.emit('answer', {
        userId,
        roomId: roomId.value,
        sdp: JSON.stringify(peerConnection.localDescription),
      })
    }
  }
  await peerConnection.setRemoteDescription(offer)
  const answer = await peerConnection.createAnswer()
  await peerConnection.setLocalDescription(answer)
}
```

### å®¢æˆ·ç«¯åˆ›å»º answer çš„é€»è¾‘

ä½œä¸ºæ¥æ”¶æ–¹ï¼Œåœ¨æ‹¿åˆ° offer åï¼Œæˆ‘ä»¬å°±å¯ä»¥åˆ›å»º answer å¹¶è®¾ç½®åˆ°æœ¬åœ°æè¿°ä¸­ï¼Œç„¶åé€šè¿‡ä¿¡ä»¤æœåŠ¡å™¨å‘é€ answer ç»™å¯¹ç«¯ã€‚

```typescript
const createAnswer = async () => {
  // è§£æå­—ç¬¦ä¸²
  const offer = JSON.parse(offerSdp)
  pc.onicecandidate = async (event) => {
    // Event that fires off when a new answer ICE candidate is created
    if (event.candidate) {
      answerSdp = JSON.stringify(pc.localDescription)
    }
  }
  await pc.setRemoteDescription(offer)
  const answer = await pc.createAnswer()
  await pc.setLocalDescription(answer)
}
```

### å®¢æˆ·ç«¯æœ€åå†æ·»åŠ  answer çš„é€»è¾‘

ä½œä¸ºå‘èµ·æ–¹ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦åœ¨å®¢æˆ·ç«¯æ¥æ”¶åˆ° æ¥æ”¶æ–¹çš„åº”ç­”åï¼Œå°†è¿™ä¸ªåº”ç­”è®¾ç½®æˆ RemoteDescriptionã€‚è¿™æ ·ï¼Œä¸€ä¸ªæœ€ç®€å•çš„ WebRTC é€šä¿¡æµç¨‹å°±å®Œæˆäº†ã€‚

```typescript
// æ·»åŠ  answer(åº”ç­”)
const addAnswer = async () => {
  const answer = JSON.parse(answerSdp)
  if (!pc.currentRemoteDescription) {
    pc.setRemoteDescription(answer)
  }
}
```

### ç¦»å¼€æˆ¿é—´

```typescript
// ç¦»å¼€æˆ¿é—´
function handleLeave() {
  // å…³é—­å¯¹ç­‰è¿æ¥
  peerConnection.close()
  // å‘é€ç¦»å¼€çš„æ¶ˆæ¯
  socket.emit('leave', { userId, roomId: roomId.value })
  // å…³é—­socketè¿æ¥
  socket.disconnect()
}
```

è¿™æ ·æˆ‘ä»¬å¤§ä½“çš„ WebRTC é€šä¿¡æµç¨‹å°±å®Œæˆäº†ï¼Œä¸‹é¢æˆ‘ä»¬å°±æŠŠå®ƒéƒ¨ç½²åˆ°æœåŠ¡å™¨ä¸Šã€‚

## éƒ¨ç½²ä¿¡ä»¤æœåŠ¡

æˆ‘ä»¬å¯ä»¥ç”¨ `Docker` é…åˆ `Nginx` æ¥éƒ¨ç½²ä½ çš„æœåŠ¡ï¼Œè¿™é‡Œä¸åšé‡ç‚¹è®²ï¼Œæˆ‘ä»¬ä¸»è¦é€šè¿‡ `pm2` æ¥å¸®å¿™éƒ¨ç½²è¿™ä¸ªæœåŠ¡ï¼Œè®©æˆ‘ä»¬å¯ä»¥å¿«æ·çš„æµ‹è¯•çœ‹çœ‹ï¼Œ `pm2` æ˜¯ä¸€ä¸ªå¸¦æœ‰è´Ÿè½½å‡è¡¡åŠŸèƒ½çš„ Node åº”ç”¨çš„è¿›ç¨‹ç®¡ç†å™¨ï¼Œå¯ä»¥è®©ä½ çš„ `Node` åº”ç”¨å§‹ç»ˆä¿æŒåœ¨çº¿ï¼ŒåŒæ—¶æä¾›äº†ä¸€äº›å…¶ä»–çš„åŠŸèƒ½ï¼Œæ¯”å¦‚æ—¥å¿—è®°å½•ã€è¿›ç¨‹ç›‘æ§ã€è¿›ç¨‹å®ˆæŠ¤ç­‰ã€‚

### å®‰è£… pm2

```sh
# å®‰è£… pm2
npm install pm2 -g
```

### å¯åŠ¨æœåŠ¡

```bash
# å¯åŠ¨
pm2 start index.js
# æŸ¥çœ‹
pm2 list
# åœæ­¢
pm2 stop index.js
# é‡å¯
pm2 restart index.js
# åˆ é™¤
pm2 delete index.js
```

### å¼€æœºè‡ªå¯åŠ¨

```bash
# ç”Ÿæˆå¼€æœºå¯åŠ¨è„šæœ¬
pm2 startup
# ä¿å­˜å½“å‰è¿›ç¨‹åˆ—è¡¨
pm2 save
```

## æœ€å

[ğŸ‘‰ğŸ» 1.æœ¬æ–‡ç¤ºä¾‹åœ¨çº¿ä½“éªŒåœ°å€](https://frontend-park.vercel.app/audio-and-video/webRTC/signaling-p2p)  
[ğŸ‘‰ğŸ» 2.æœ¬æ–‡å®¢æˆ·ç«¯æºä»£ç åœ°å€](https://github.com/wangrongding/frontend-park)  
[ğŸ‘‰ğŸ» 3.æœ¬æ–‡æœåŠ¡ç«¯æºä»£ç åœ°å€](https://github.com/wangrongding/node-park/blob/main/src/signaling/signaling-http-server.js)

ä½ å¯ä»¥å¼€ä¸¤ä¸ªæµè§ˆå™¨ tab æˆ–è€…ç”¨ä¸åŒçš„è®¾å¤‡ï¼Œè¾“å…¥æˆ¿é—´å·è¿›å»ä½“éªŒä¸‹ã€‚

![](https://assets.fedtop.com/picbed/202211132359202.png)

æœ¬ç¯‡æ–‡ç« ä¸»è¦æ˜¯é€šè¿‡ä¿¡ä»¤æœåŠ¡é˜Ÿä¸Šä¸€ç¯‡æ–‡ç« çš„è¿›é˜¶å¤„ç†ï¼Œå®ç°äº†è‡ªåŠ¨è¿æ¥çš„éŸ³è§†é¢‘é€šè¯ã€‚å¤§å®¶å¦‚æœæœ‰ä»€ä¹ˆé—®é¢˜ï¼Œå¯ä»¥åœ¨è¯„è®ºåŒºç•™è¨€ï¼Œæˆ‘ä¼šåŠæ—¶å›å¤ã€‚

æ‰€æœ‰çš„æ–‡ç« éƒ½åœ¨ [ğŸ‘‰ğŸ» è¿™ä¸ªä¸“æ ä¸­](https://juejin.cn/column/7139951010042085407) ï¼Œå¦‚æœæ‚¨å–œæ¬¢è¿™ä¸ªä¸“æ çš„æ–‡ç« ï¼Œæˆ–è€…å¯¹æ‚¨æœ‰ä¸€äº›å¸®åŠ©ï¼Œå¯ä»¥ç‚¹èµé¼“åŠ±ï¼Œæˆ‘ä¼šç»§ç»­äº§å‡ºæ›´å¥½çš„æ–‡ç« ç»™å¤§å®¶ ~ è°¢è°¢ ğŸ¥°
